<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hat Sorgulama</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            background-color: #0d0d1a;
            color: #e0e0e0;
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            max-width: 100vw;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            margin-left: 0;
            transition: margin-left 0.3s ease-in-out;
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .square-container {
            background: linear-gradient(145deg, #1a1a2e 0%, #252542 100%);
            border: 1px solid rgba(138, 108, 241, 0.1);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .input-box {
            background: rgba(13, 13, 26, 0.6);
            border: 1px solid rgba(138, 108, 241, 0.2);
            color: #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .input-box:focus {
            border-color: #8a6cf1;
            box-shadow: 0 0 0 2px rgba(138, 108, 241, 0.2);
            outline: none;
        }

        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(138, 108, 241, 0.2);
            border-radius: 8px;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(138, 108, 241, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: rgba(138, 108, 241, 0.1);
        }

        .suggestion-item.selected {
            background: rgba(138, 108, 241, 0.2);
            color: #fff;
        }

        .line-code {
            background: rgba(138, 108, 241, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
            color: #8a6cf1;
            min-width: 60px;
            text-align: center;
        }

        .button {
            background: linear-gradient(135deg, #6a4cff 0%, #8a6cf1 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: center;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(106, 76, 255, 0.3);
        }

        .result-card {
            background: linear-gradient(145deg, #1a1a2e 0%, #252542 100%);
            border: 1px solid rgba(138, 108, 241, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(138, 108, 241, 0.1);
        }

        th {
            background: rgba(138, 108, 241, 0.1);
            color: #8a6cf1;
            font-weight: 600;
        }

        tr:hover td {
            background: rgba(138, 108, 241, 0.05);
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(13, 13, 26, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            z-index: 1050;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #8a6cf1;
        }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1a1a2e;
            transition: .4s;
            border-radius: 34px;
            border: 2px solid #8a6cf1;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 2px;
            bottom: 2px;
            background-color: #8a6cf1;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .switch-label {
            margin: 0 1rem;
            color: #8a6cf1;
            font-weight: 500;
        }

        .announcement {
            background: rgba(138, 108, 241, 0.1);
            border-left: 4px solid #8a6cf1;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .announcement.level-3 {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .announcement.level-2 {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .announcement.level-1 {
            border-left-color: #8a6cf1;
        }
    </style>
</head>
<body>
    <nav class="bg-gradient-to-b from-[#1a1a2e] to-[#252542] p-4 fixed top-0 w-full z-20">
        <div class="flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-[#8a6cf1]">iettnext</a>
            <div class="flex space-x-4">
                <a href="/durak" class="text-gray-300 hover:text-white">Durak</a>
                <a href="/hat" class="text-gray-300 hover:text-white">Hat</a>
                <a href="/arac" class="text-gray-300 hover:text-white">Araç</a>
                <a href="/harita" class="text-gray-300 hover:text-white">Harita</a>
                <a href="/eski" class="text-gray-300 hover:text-white">Eski Hatlar</a>
                <a href="/about" class="text-white font-medium">Hakkında</a>
            </div>
        </div>
    </nav>
    <div class="pt-20"></div>
    <div class="content">
        <div id="searchContainer" class="square-container">
            <h1 class="text-3xl font-bold mb-6 text-center text-[#8a6cf1]">Hat Sorgulama</h1>
            <div class="relative">
                <input 
                    id="lineInput" 
                    type="text" 
                    placeholder="Hat kodu veya adı girin..." 
                    class="input-box w-full p-4 mb-4 text-lg"
                    autocomplete="off"
                >
                <div id="suggestions" class="suggestions-container hidden"></div>
            </div>
            <button id="refreshBtn" class="button hidden">Ara</button>
        </div>
        <div id="announcements" class="mt-4"></div>
        <div id="results" class="mt-6 w-full"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/Rednexie/rednexie.github.io@main/cdn/noconsole.js"></script>
    <script>
        let currentDirection = 0;

        let selectedIndex = -1;
        let suggestions = [];

        document.getElementById('lineInput').addEventListener('input', async function(e) {
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('suggestions').classList.add('hidden');
                return;
            }

            try {
                const res = await fetch(`/api/line-suggestions?q=${encodeURIComponent(query)}`);
                if (!res.ok) throw new Error('Failed to fetch line suggestions');
                suggestions = await res.json();
                
                const suggestionsHtml = suggestions.map((line, index) => `
                    <div class="suggestion-item ${index === selectedIndex ? 'selected' : ''}" 
                         data-index="${index}">
                        <span class="line-code">${line.line}</span>
                        <span>${line.name}</span>
                    </div>
                `).join('');

                const suggestionsContainer = document.getElementById('suggestions');
                suggestionsContainer.innerHTML = suggestionsHtml;
                suggestionsContainer.classList.remove('hidden');

                document.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        selectLine(suggestions[index]);
                    });
                });
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                document.getElementById('suggestions').innerHTML = '<div class="suggestion-item text-red-400">Öneriler alınamadı.</div>';
                suggestions = [];
            }
        });

        document.getElementById('lineInput').addEventListener('keydown', function(e) {
            const suggestionsContainer = document.getElementById('suggestions');
            const input = document.getElementById('lineInput');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();

                if (selectedIndex >= 0) {
                    selectLine(suggestions[selectedIndex]);
                } else if (input.value.trim()) {
                    selectLine({ line: input.value.trim().toUpperCase(), name: input.value.trim() || 'Bilinmeyen Hat' });
                }
                suggestionsContainer.classList.add('hidden');
            } else if (e.key === 'Escape') {
                suggestionsContainer.classList.add('hidden');
            }
        });

        function updateSelection() {
            document.querySelectorAll('.suggestion-item').forEach((item, index) => {
                item.classList.toggle('selected', index === selectedIndex);
            });
        }

        function displayAnnouncements(announcements) {
            const announcementsDiv = document.getElementById('announcements');
            if (!announcements || announcements.length === 0) {
                announcementsDiv.innerHTML = '';
                return;
            }

            const announcementsHtml = announcements.map(ann => {
                // Split content by '|' or by sentence for multi-line display
                let lines = [];
                if (ann.content && ann.content.includes('|')) {
                    lines = ann.content.split('|').map(s => s.trim());
                } else if (ann.content && ann.content.length > 120) {
                    // fallback: split by sentence if too long
                    lines = ann.content.split(/(?<=\.|!|\?)\s+/g);
                } else {
                    lines = [ann.content];
                }
                return `
                    <div class="announcement level-${ann.level || 1}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm text-gray-400">${ann.date}</span>
                            <span class="px-2 py-1 rounded text-xs ${ann.level === 3 ? 'bg-red-500' : ann.level === 2 ? 'bg-yellow-500' : 'bg-purple-500'} text-white">
                                ${ann.category || 'Genel'}
                            </span>
                        </div>
                        <div class="text-white">
                            ${lines.map(line => `<div>${line}</div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            announcementsDiv.innerHTML = announcementsHtml;
        }

        async function selectLine(line) {
            document.getElementById('lineInput').value = line.line;
            document.getElementById('suggestions').classList.add('hidden');
            document.getElementById('refreshBtn').classList.remove('hidden');
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="text-gray-300 text-center text-lg">Yükleniyor...</p>';
            document.getElementById('searchContainer').classList.add('hidden');

            try {
                const [timetableRes, announcementsRes] = await Promise.all([
                    fetch('/time-table', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ line: line.line })
                    }),
                    fetch('/announcements', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ line: line.line })
                    })
                ]);

                if (!timetableRes.ok) throw new Error('Failed to fetch timetable');
                if (!announcementsRes.ok) throw new Error('Failed to fetch announcements');

                const [timetable, announcements] = await Promise.all([
                    timetableRes.json(),
                    announcementsRes.json()
                ]);
                
                let displayName = line.name;
                try {
                    const nameRes = await fetch(`/api/line-suggestions?q=${encodeURIComponent(line.line)}`);
                    if (nameRes.ok) {
                        const names = await nameRes.json();
                        if (names.length) displayName = names[0].name;
                    }
                } catch {};

                displayAnnouncements(announcements);
                displayResults(line.line, displayName, timetable);

            } catch (error) {
                console.error('Error fetching line details:', error);
                resultsDiv.innerHTML = '<p class="text-red-500 text-center text-lg">Hat bilgileri alınamadı. Lütfen tekrar deneyin.</p>';
                document.getElementById('searchContainer').classList.remove('hidden');
            }
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('#lineInput') && !e.target.closest('#suggestions')) {
                document.getElementById('suggestions').classList.add('hidden');
            }
        });

        function resetSearch() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('announcements').innerHTML = '';
            document.getElementById('searchContainer').classList.remove('hidden');
            document.getElementById('lineInput').value = '';
            document.getElementById('refreshBtn').classList.add('hidden');
            selectedIndex = -1;
            suggestions = [];
            document.getElementById('suggestions').innerHTML = '';
        }

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const lineCode = document.getElementById('lineInput').value.trim().toUpperCase();
            if (lineCode) {
                selectLine({ line: lineCode, name: 'Bilinmeyen Hat' });
            }
        });

        function displayResults(lineCode, lineName, timetable) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="button-group">
                    <button onclick="resetSearch()" class="button">Yeni Arama</button>
                </div>
                <div class="switch-container">
                    <span class="switch-label">Gidiş</span>
                    <label class="switch">
                        <input type="checkbox" id="directionSwitch" onchange="handleDirectionChange(this.checked)">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label">Dönüş</span>
                </div>
                <div class="result-card">
                    <div class="flex items-center gap-4 mb-4">
                        <span class="line-code text-xl">${lineCode}</span>
                        <h2 class="text-2xl font-bold text-[#8a6cf1]">${lineName}</h2>
                    </div>
                    ${timetable && timetable.length > 0 ? `
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Sefer Saatleri</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="overflow-x-auto">
                                <div style="overflow-x:auto;width:100%">
                                <table class="min-w-full text-left" style="min-width: 400px; max-width: 100%;">
                                    <thead>
                                        <tr class="bg-[#2a2a4e]">
                                            <th class="p-2">Saat</th>
                                            <th class="p-2">Gün</th>
                                            <th class="p-2">Hizmet</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${timetable.map(item => {
                                            const time = item.K_ORER_DTSAATGIDIS?.split(' ')[1]?.slice(0, 5) || 'N/A';
                                            const dayCode = item.K_ORER_DTSAATGUN || item.K_ORER_SGUNTIPI || '';
                                            const dayMap = { I: 'İş Günleri', C: 'Cumartesi', P: 'Pazar' };
                                            const dayName = dayMap[dayCode] || dayCode || 'N/A';
                                            const svcCode = item.K_ORER_DTSAATLVTIP || item.K_ORER_SSERVISTIPI || '';
                                            const svcMap = { '0': 'Normal', '1': 'Express', '2': 'Ekspres' };
                                            const svcName = svcMap[svcCode] || svcCode || 'N/A';
                                            return `
                                                <tr>
                                                    <td class="p-2">${time}</td>
                                                    <td class="p-2">${dayName}</td>
                                                    <td class="p-2">${svcName}</td>
                                                </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div id="stationList" class="p-4 bg-[#1a1a2e] border border-[#8a6cf1]/20 rounded-lg text-gray-200"></div>
                        </div>
                    </div>
                    ` : '<p class="mt-4 text-gray-400">Bu hat için sefer saatleri bulunmamaktadır.</p>'}
                </div>
            `;
            GetStationForRoute(lineCode, lineCode, lineCode, 1, currentDirection);
        }

        function handleDirectionChange(checked) {
            currentDirection = checked ? 1 : 0;
            const lineCode = document.getElementById('lineInput').value.trim().toUpperCase();
            GetStationForRoute(lineCode, lineCode, lineCode, 1, currentDirection);
        }

        function GetStationForRoute(hkod, hstart, hend, langid = 1, direction = 0) {
            const params = new URLSearchParams({ hatkod: hkod, hatstart: hstart, hatend: hend, langid });
            fetch(`/api/route-stations?${params.toString()}`, { method: 'GET' })
                .then(res => res.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const allAnchors = Array.from(doc.querySelectorAll('a'));
                    const half = Math.ceil(allAnchors.length / 2);
                    const selectedAnchors = direction === 0 ? allAnchors.slice(0, half) : allAnchors.slice(half);
                    const stops = selectedAnchors.map(a => a.textContent.trim()).filter(Boolean);
                    
                    let stopsHtml = `<div class="relative metro-diagram flex flex-col items-start ml-4 space-y-2">`;
                    stopsHtml += `<div class="absolute left-2 top-3 bottom-3 w-1 bg-[#8a6cf1] z-0" style="min-height:32px;"></div>`;
                    stops.forEach(s => {
                        stopsHtml += `<div class="flex items-center relative min-h-[42px] z-10">
                            <div class="w-5 h-5 rounded-full bg-[#8a6cf1] border-2 border-white z-10"></div>
                            <span class="ml-4 text-base font-semibold text-white">${s}</span>
                        </div>`;
                    });
                    stopsHtml += `</div>`;
                    document.getElementById('stationList').innerHTML = stopsHtml;
                    if (typeof routeevent === 'function') routeevent();
                })
                .catch(err => console.error('Error fetching stations:', err));
        }
    </script>
</body>
</html>