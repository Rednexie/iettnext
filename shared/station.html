<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iettnext</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            background-color: #0d0d1a;
            color: #e0e0e0;
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4e 100%);
            color: #8a6cf1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            margin-left: 0;
            transition: margin-left 0.3s ease-in-out;
        }

        @media (min-width: 768px) {
            .content {
                margin-left: 200px;
                align-items: center;
            }
        }

        .square-container {
            background: linear-gradient(145deg, #1a1a2e 0%, #252542 100%);
            border: 1px solid rgba(138, 108, 241, 0.1);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            margin-left: auto;
            margin-right: auto;
        }

        .input-box {
            background: rgba(13, 13, 26, 0.6);
            border: 1px solid rgba(138, 108, 241, 0.2);
            color: #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .suggestions {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(138, 108, 241, 0.1);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 4rem);
            margin-top: 4px;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-item:hover {
            background: rgba(138, 108, 241, 0.1);
        }

        .result-card {
            background: linear-gradient(145deg, #1a1a2e 0%, #252542 100%);
            border: 1px solid rgba(138, 108, 241, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            width: 100%;
            max-width: 600px;
            transition: all 0.3s ease;
            margin-left: auto;
            margin-right: auto;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .result-card h3 {
            color: #8a6cf1;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .result-card p {
            margin: 0.5rem 0;
            line-height: 1.5;
        }

        .feature-icon {
            margin: 0 0.5rem;
            transition: all 0.3s ease;
        }

        .feature-icon:hover {
            transform: scale(1.2);
        }

        .tamkonum-link {
            color: #8a6cf1;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .tamkonum-link:hover {
            color: #9a7cf2;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <nav class="bg-gradient-to-b from-[#1a1a2e] to-[#252542] p-4 fixed top-0 w-full z-20">
        <div class="flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-[#8a6cf1]">iettnext</a>
            <div class="flex space-x-4">
                <a href="/durak" class="text-gray-300 hover:text-white">Durak</a>
                <a href="/hat" class="text-gray-300 hover:text-white">Hat</a>
                <a href="/arac" class="text-gray-300 hover:text-white">Araç</a>
                <a href="/harita" class="text-gray-300 hover:text-white">Harita</a>
                <a href="/eski" class="text-gray-300 hover:text-white">Eski Hatlar</a>
                <a href="/about" class="text-white font-medium">Hakkında</a>
            </div>
        </div>
    </nav>
    <div class="pt-20"></div>
    <div class="content">
        <div class="square-container">
            <h1 class="text-3xl font-bold mb-6 text-center text-[#8a6cf1]">Durak Sorgulama</h1>
            <input 
                type="text" 
                id="stationInput" 
                class="input-box mb-4" 
                placeholder="Durak adı veya kodu girin"
                oninput="fetchSuggestions()"
                style="margin-left:auto;margin-right:auto;"
            >
            <button id="refreshBtn" class="button w-full py-2 px-4 mb-4 text-white rounded-lg text-lg bg-purple-600 hover:bg-purple-700 hidden" onclick="refreshArrivals()">
                <i class="fas fa-sync-alt"></i> Yenile
            </button>
            <div id="suggestions" class="suggestions"></div>
        </div>
        <div id="results" class="w-full max-w-4xl mt-8 flex flex-col items-center"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/Rednexie/rednexie.github.io@main/cdn/noconsole.js"></script>
    <script>
        async function fetchSuggestions() {
            const query = document.getElementById('stationInput').value.trim();
            if (!query) {
                document.getElementById('suggestions').innerHTML = '';
                return;
            }

            try {
                const response = await fetch('/station-suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();
                displaySuggestions(data);
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        }

        function displaySuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.innerHTML = '';

            suggestions.forEach(suggestion => {
                if(suggestion.DURAK_DURAK_KODU < 0) return;
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = `${suggestion.DURAK_ADI} (${suggestion.DURAK_YON_BILGISI})`;
                div.onclick = () => selectSuggestion(suggestion);
                suggestionsContainer.appendChild(div);
            });
        }

        async function selectSuggestion(suggestion) {
            document.getElementById('stationInput').value = suggestion.DURAK_ADI;
            document.getElementById('suggestions').innerHTML = '';
            window.selectedStop = suggestion; // Store selected stop globally
            document.getElementById('refreshBtn').classList.remove('hidden');

            try {
                const response = await fetch('/bus-arrivals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stopId: suggestion.DURAK_DURAK_KODU })
                });
                const data = await response.json();
                displayStationResults(data);
            } catch (error) {
                console.error('Error querying the server:', error);
            }
        }

        async function refreshArrivals() {
            if (!window.selectedStop) return;
            try {
                const response = await fetch('/bus-arrivals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stopId: window.selectedStop.DURAK_DURAK_KODU })
                });
                const data = await response.json();
                displayStationResults(data);
            } catch (error) {
                console.error('Error refreshing arrivals:', error);
            }
        }

        async function displayStationResults(results) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center mt-4 text-gray-400">Varacak otobüs bulunamadı.</p>';
                return;
            }

            for (const result of results) {
                const card = document.createElement('div');
                card.className = 'result-card';

                const title = document.createElement('h3');
                title.textContent = `${result.hatkodu}${result.depar ? '-' : ''} => ${result.saat} (${result.dakika} dk) ${result.son_hiz} km/sa`;
                card.appendChild(title);

                const lineInfo = document.createElement('p');
                lineInfo.textContent = result.hatadi;
                card.appendChild(lineInfo);

                const carInfo = document.createElement('p');
                carInfo.innerHTML = `
                    <span>${result.kapino} (${result.ototip})</span>
                    <i class="fas fa-wifi feature-icon" style="color: ${result.wifi ? '#4ade80' : '#ef4444'};"></i>
                    <i class="fas fa-snowflake feature-icon" style="color: ${result.klima ? '#4ade80' : '#ef4444'};"></i>
                    <i class="fas fa-charging-station feature-icon" style="color: ${result.usb ? '#4ade80' : '#ef4444'};"></i>
                    <i class="fas fa-wheelchair feature-icon" style="color: ${result.engelli ? '#4ade80' : '#ef4444'};"></i>
                    <i class="fas fa-bicycle feature-icon" style="color: ${result.bisiklet ? '#4ade80' : '#ef4444'};"></i>
                `;
                card.appendChild(carInfo);

                try {
                        const [lon, lat] = result.son_konum.split(',').map(coord => parseFloat(coord.trim()));

                        if (!isNaN(lon) && !isNaN(lat)) {
                            const cacheKey = `location-transform-${lon},${lat}`;
                            let locationData = localStorage.getItem(cacheKey);
                            if (locationData) {
                                // Use cached value
                                const locationInfo = document.createElement('p');
                                const locationLink = document.createElement('a');
                                locationLink.href = `https://www.google.com/maps?q=${lat},${lon}`;
                                locationLink.target = '_blank';
                                locationLink.className = 'tamkonum-link';
                                locationLink.textContent = locationData;
                                locationInfo.appendChild(locationLink);
                                card.appendChild(locationInfo);
                            } else {
                                // Fetch and cache
                                const locationResponse = await fetch('/location-transform', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ lon, lat })
                                });
                                locationData = await locationResponse.text();
                                localStorage.setItem(cacheKey, locationData);
                                const locationInfo = document.createElement('p');
                                const locationLink = document.createElement('a');
                                locationLink.href = `https://www.google.com/maps?q=${lat},${lon}`;
                                locationLink.target = '_blank';
                                locationLink.className = 'tamkonum-link';
                                locationLink.textContent = locationData;
                                locationInfo.appendChild(locationLink);
                                card.appendChild(locationInfo);
                            }
                        } else {
                            const locationInfo = document.createElement('p');
                            locationInfo.textContent = 'Konum Bilinmiyor';
                            card.appendChild(locationInfo);
                        }
                    } catch (error) {
                    console.error('Error fetching location data:', error);
                    const locationInfo = document.createElement('p');
                    locationInfo.textContent = 'Konum Bilinmiyor';
                    card.appendChild(locationInfo);
                }
                resultsContainer.appendChild(card);
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('stationInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    fetchSuggestions();
                }
            });
        });
    </script>
</body>
</html>